name: Mirror Repo
on:
  schedule:
    - cron: '0 0 * * *'
  push:
    branches:
      - sync # Push empty commit to this branch to trigger sync

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Mirror
      run: |
        git clone --mirror "https://git:$OVERLEAF_GIT_PASSWORD@tex.zih.tu-dresden.de/git/$OVERLEAF_GIT_PROJECT"
        cd $OVERLEAF_GIT_PROJECT.git
        git branch -m master main
        git remote add github "https://$GITHUB_ACTOR:$GITHUB_TOKEN@github.com/$GITHUB_REPOSITORY.git"
        git push --mirror github
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        OVERLEAF_GIT_PASSWORD: ${{ secrets.OVERLEAF_GIT_PASSWORD }}
        OVERLEAF_GIT_PROJECT: ${{ secrets.OVERLEAF_GIT_PROJECT }}
  # Make a PDF of the main.tex file
  pdf:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Install LaTeX
      uses: xu-cheng/latex-action@v2
      with:
        root_file: main.tex
        args: -f -pdf
    - name: Build
      run: latexmk -pdf main.tex
    - name: Upload PDF to releases
      uses: softprops/action-gh-release@v1
      with:
        files: |
          main.pdf
        tag_name: ${{ github.sha }}
        name: ${{ github.sha }}
        body: ${{ github.sha }}